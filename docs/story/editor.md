# ストーリーエディタ設計

本書では Solid.js で実装する簡易ストーリーエディタの設計方針をまとめる。
画像または動画を読み込み、縦向きのキャンバス上でオーバーレイを配置する。
画像のみの場合は PNG を生成し、動画が含まれる場合は **ffmpeg.wasm** を用いて
各フレームにオーバーレイを合成した MP4 を作成する。配置情報は `x:overlays`
として保存する。

## 機能概要

1. 画像または動画をアップロード（URL 指定も可）
2. 動画は **ffmpeg.wasm**
   で読み込み、先頭フレームを抽出して編集用キャンバスに表示
3. メンションや質問箱の位置を編集 UI で指定する
4. `Export` を実行すると画像なら PNG、動画ならオーバーレイを合成した MP4 を生成
5. `x:overlays` に配置情報を JSON 形式で保存

## オーバーレイデータ形式

`x:overlays` の各要素は以下のフィールドを持つ。

| フィールド | 役割                                         |
| ---------- | -------------------------------------------- |
| `id`       | オーバーレイ識別子                           |
| `kind`     | `mention` `question` など種類を示す文字列    |
| `ref`      | メンション先 Actor など関連オブジェクトの ID |
| `bbox`     | `[x,y,w,h]` (0〜1 正規化)                    |
| `rotation` | 角度 (任意)                                  |

## UI 操作

1. メディア選択後、`<canvas>` に背景を描画する。動画の場合は **ffmpeg.wasm**
   で先頭フレームを抽出して表示する。
2. 追加ボタンからメンション／質問箱を選択すると編集レイヤが生成され、ドラッグで位置とサイズを調整できる。
3. 完了後、`Export` を押すと画像の場合は PNG、動画の場合は MP4 と `x:overlays`
   配列を返す。

これにより未対応クライアントでも元画像を表示しつつ、対応実装では質問やメンション等の機能を提供できる。
