# 🐙 Takos 拡張機能仕様書 v3

> **仕様バージョン**: v3.0 (ドラフト) **最終更新**: 2025-06-11

## 🎯 目次
1. [目的](#目的)
2. [用語](#用語)
3. [パッケージ構造](#パッケージ構造)
4. [manifest.json 詳細仕様](#manifestjson-詳細仕様)
5. [名前空間と衝突回避](#名前空間と衝突回避)
6. [APIと権限](#apiと権限)
7. [globalThis.takos API](#globalthistakos-api)
8. [ActivityPub フック](#activitypub-フック)
9. [イベント定義](#イベント定義)
10. [v2.1からの移行ガイド](#v21からの移行ガイド)
11. [Sandbox 実行環境](#sandbox-実行環境)
12. [拡張機能間API連携](#拡張機能間api連携)

---

## 目的

Takos を VSCode ライクに安全かつ柔軟に拡張するための共通仕様を定義します。拡張は **server.js**、**client.js**、**index.html** の 3 ファイルで完結し、Deno 互換環境上で実行されます。

---

## 用語

| 用語 | 説明 |
| ---- | ---- |
| Pack (.takopack) | zip 形式の拡張パッケージ。トップに `takos/` フォルダを持つ |
| Identifier | `com.example.foo` のような逆 FQDN。`takos` は予約済み |
| Permission | `resource:action(:scope)` 形式の権限文字列 |
| ExtensionDependencies | 他拡張への依存定義 |
| Exports | 外部公開 API の一覧 |

---

## パッケージ構造

```
awesome-pack.takopack
└─ takos/
   ├─ manifest.json  # 必須
   ├─ server.js      # サーバー
   ├─ client.js      # バックグラウンド
   └─ index.html     # UI
```

`server.js` と `client.js` は依存のない単一ファイルです。`index.html` は UI を提供します。

---

## manifest.json 詳細仕様

`manifest.json` は [manifest.schema.json](./manifest.schema.json) で検証できます。主なフィールドは次のとおりです。

```jsonc
{
  "name": "awesome-pack",
  "description": "拡張機能の説明",
  "version": "1.2.0",
  "identifier": "com.example.awesome",
  "icon": "./icon.png",
  "apiVersion": "3.0",

  "extensionDependencies": [
    { "identifier": "com.example.lib", "version": "^1.0.0" }
  ],

  "exports": {
    "server": ["calculateHash", "sign"],
    "background": [],
    "ui": []
  },

  "permissions": [
    "fetch:net",
    "activitypub:send",
    "activitypub:read",
    "activitypub:receive:hook",
    "activitypub:actor:read",
    "activitypub:actor:write",
    "plugin-actor:create",
    "plugin-actor:read",
    "plugin-actor:write",
    "plugin-actor:delete",
    "kv:read",
    "kv:write",
    "cdn:read",
    "cdn:write",
    "events:publish",
    "events:subscribe",
    "extensions:invoke",
    "extensions:export",
    "deno:read",
    "deno:write",
    "deno:net",
    "deno:env",
    "deno:run",
    "deno:sys",
    "deno:ffi"
  ],

  "server": { "entry": "./server.js" },
  "client": {
    "entryUI": "./index.html",
    "entryBackground": "./client.js"
  },

  "activityPub": {
    "objects": [{
      "accepts": ["Note", "Create", "Like"],
      "context": "https://www.w3.org/ns/activitystreams",
      "hooks": {
        "canAccept": "canAccept",
        "onReceive": "onReceive",
        "priority": 1,
        "serial": false
      }
    }]
  },

  "eventDefinitions": {
    "postMessage": {
      "source": "client",
      "handler": "onPostMessage"
    },
    "notifyClient": {
      "source": "server",
      "handler": "onNotifyClient"
    }
  }
}
```

---

## 名前空間と衝突回避

- Identifier は逆 FQDN 形式を採用し衝突を避けます。
- KV とアセットは `identifier` 毎に名前空間分離されます。
  - KV: `${identifier}:${key}`
  - CDN: `${identifier}/${path}`
- 同名関数を export しても識別子ごとに独立するため衝突しません。
- 依存解決は npm-semver 準拠で最新版優先、警告あり。

---

## APIと権限

主要 API のメソッドシグネチャと必要権限は以下の通りです。

### ActivityPub

#### オブジェクト操作
- **send**: `takos.activitypub.send(userId: string, activity: object): Promise<void>`
  - **必要権限**: `activitypub:send`
- **read**: `takos.activitypub.read(id: string): Promise<object>`
  - **必要権限**: `activitypub:read`
- **delete**: `takos.activitypub.delete(id: string): Promise<void>`
  - **必要権限**: `activitypub:send`
- **list**: `takos.activitypub.list(userId?: string): Promise<string[]>`
  - **必要権限**: `activitypub:read`

#### フック処理
- ActivityPub オブジェクト受信時のフック (`canAccept`, `onReceive`)
  - **必要権限**: `activitypub:receive:hook`

#### アクター操作
- **read**: `takos.activitypub.actor.read(userId: string): Promise<object>`
- **update**: `takos.activitypub.actor.update(userId: string, key: string, value: string): Promise<void>`
- **delete**: `takos.activitypub.actor.delete(userId: string, key: string): Promise<void>`
- **follow**: `takos.activitypub.follow(followerId: string, followeeId: string): Promise<void>`
- **unfollow**: `takos.activitypub.unfollow(followerId: string, followeeId: string): Promise<void>`
- **listFollowers**: `takos.activitypub.listFollowers(actorId: string): Promise<string[]>`
- **listFollowing**: `takos.activitypub.listFollowing(actorId: string): Promise<string[]>`
  - **必要権限**: `activitypub:actor:read` / `activitypub:actor:write`

### プラグインアクター操作
- **create**: `takos.activitypub.pluginActor.create(localName: string, profile: object): Promise<string>`
- **read**: `takos.activitypub.pluginActor.read(iri: string): Promise<object>`
- **update**: `takos.activitypub.pluginActor.update(iri: string, partial: object): Promise<void>`
- **delete**: `takos.activitypub.pluginActor.delete(iri: string): Promise<void>`
- **list**: `takos.activitypub.pluginActor.list(): Promise<string[]>`
  - **必要権限**: `plugin-actor:create` / `plugin-actor:read` / `plugin-actor:write` / `plugin-actor:delete`

### kv
- **read**: `takos.kv.read(key: string): Promise<any>`
- **write**: `takos.kv.write(key: string, value: any): Promise<void>`
- **delete**: `takos.kv.delete(key: string): Promise<void>`
- **list**: `takos.kv.list(): Promise<string[]>`
  - **必要権限**: `kv:read` / `kv:write`
  - `server.js` と `client.js` / `index.html` のストレージは独立

### fetch
- **fetch**: `takos.fetch(url: string, options?: object): Promise<Response>`
  - **必要権限**: `fetch:net`  (クライアントでは `client.allowedConnectSrc` 設定が必要)

### cdn
- **read**: `takos.cdn.read(path: string): Promise<string>`
- **write**: `takos.cdn.write(path: string, data: string | Uint8Array, options?: { cacheTTL?: number }): Promise<string>`
- **delete**: `takos.cdn.delete(path: string): Promise<void>`
- **list**: `takos.cdn.list(prefix?: string): Promise<string[]>`
  - **必要権限**: `cdn:read` / `cdn:write`
  - **制限**: 合計 20MB まで。エンドポイント `/cdn/<identifier>/<path>`

### events
イベントは manifest.json の `eventDefinitions` で宣言します。各レイヤー (server, client, background, ui) からは同じ API で実行できます。

- `takos.events.publish(eventName: string, payload: any): Promise<[number, object]> | Promise<void>`
  - 送信先が `server` の場合、ハンドラーが返す `[status, body]` を取得します。その他のレイヤー向けは `void` を返します。
- `takos.events.subscribe(eventName: string, handler: (payload: any) => void): () => void`
  - **必要権限**: `events:publish` / `events:subscribe`
  - **レート制限**: 10 件/秒

### 拡張間 API
- `takos.extensions.get(identifier: string): Extension | undefined`
- `Extension.activate(): Promise<any>`
  - **必要権限**: `extensions:invoke` / `extensions:export`

権限はすべて `manifest.permissions` に列挙し、必要最低限を宣言してください。

---

## globalThis.takos API

Takos の各 API は `globalThis` 上の `takos` オブジェクトとして公開されます。
そのため、各スクリプトの冒頭で次のように取得して利用します。

```javascript
const { takos } = globalThis;
```

```typescript
namespace takos.extensions {
  function get(identifier: string): Extension | undefined;
  const all: Extension[];
}
interface Extension {
  identifier: string;
  version: string;
  isActive: boolean;
  activate(): Promise<any>;
}
```

利用例:

```javascript
const ext = takos.extensions.get("com.example.lib");
if (ext) {
  const api = await ext.activate();
  const hash = await api.calculateHash("hello");
}
```

その他の API も `takos.*` 名前空間に集約されています。

---

## ActivityPub フック

`activityPub.objects.accepts` に指定したオブジェクトを受信すると、各 Pack の `canAccept` → `onReceive` が順に呼ばれます。`serial: true` を指定すると優先度順に逐次実行されます。

```javascript
const afterA = await PackA.onReceive(obj);
const afterB = await PackB.onReceive(afterA);
```

---

## イベント定義

`eventDefinitions` にイベントを宣言し、`server.js` 等でハンドラーを実装します。

```jsonc
{
  "eventDefinitions": {
    "myEvent": {
      "source": "client",
      "handler": "onMyEvent"
    }
  }
}
```

- 送信元は `client`、`server`、`background`、`ui` のいずれか
- 対象レイヤーはハンドラーを実装したファイルで決まります

サーバー側ハンドラーは `[200|400|500, body]` を返します。

定義したイベントは、どのレイヤーからも共通の `takos.events.publish(eventName, payload)` で発行できます。

---

## v2.1からの移行ガイド

1. 権限宣言を `manifest.permissions` に集約。
2. イベント定義は `source` のみを指定し、ハンドラー実装側が受信先となります。
3. ActivityPub API は `activityPub()` に統合。
4. `extensionDependencies` と `exports` を利用し、`takos.extensions` API で他拡張と連携。

---

## Sandbox 実行環境

- すべてのレイヤーはサンドボックスで分離されます。
- `activate()` の戻り値は structuredClone 準拠でシリアライズ。
- 呼び出し権限は export 元の範囲に限定され、依存循環はエラーとなります。

---

## 拡張機能間API連携

### 記述方法
- `extensionDependencies` で依存 Pack を宣言し、未インストール時は UI で通知。
- `exports` で公開関数をレイヤーごとに列挙します。

### 権限制御
- `extensions:export` 他拡張へ API を公開する権限。
- `extensions:invoke` 他拡張の API を取得する権限。

### 利用方法

```javascript
const ext = takos.extensions.get("com.example.lib");
if (ext) {
  const api = await ext.activate();
  await api.doSomething();
}
```

TypeScript で型安全に連携でき、npm-semver 準拠で依存解決されます。

---
